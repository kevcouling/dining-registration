<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dining Registration</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --navy: #002855;
            --gold: #B8860B;
            --light-gold: #D4AF37;
            --white: #FFFFFF;
            --light-gray: #F5F5F5;
            --medium-gray: #E0E0E0;
            --text-dark: #333333;
            --text-light: #666666;
            --error: #C41E3A;
            --success: #2E7D32;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--light-gray);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, var(--navy) 0%, #003d7a 100%);
            color: var(--white);
            padding: 2rem 1rem;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .logo-placeholder {
            width: 150px;
            height: 80px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 2px dashed var(--gold);
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--gold);
            font-size: 0.875rem;
            border-radius: 4px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 300;
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .event-info {
            background: var(--white);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
            border-left: 4px solid var(--gold);
        }

        .event-info h2 {
            color: var(--navy);
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: 400;
        }

        .event-detail {
            margin-bottom: 0.75rem;
        }

        .event-detail strong {
            color: var(--navy);
            display: inline-block;
            min-width: 120px;
        }

        .menu-section {
            background: var(--light-gray);
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            border: 1px solid var(--medium-gray);
        }

        .menu-section h3 {
            color: var(--navy);
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            font-weight: 500;
        }

        .menu-section p {
            white-space: pre-line;
            color: var(--text-light);
            line-height: 1.8;
        }

        .cost-notice {
            background: linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%);
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            border-left: 3px solid var(--gold);
            font-weight: 500;
        }

        .submitted-diners {
            background: var(--white);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }

        .submitted-diners h2 {
            color: var(--navy);
            margin-bottom: 1rem;
            font-size: 1.3rem;
            font-weight: 400;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .submitted-diners h2::before {
            content: "✓";
            background: var(--success);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
        }

        .diner-list {
            list-style: none;
        }

        .diners-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
        }

        .diners-table th,
        .diners-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--medium-gray);
        }

        .diners-table th {
            background: var(--navy);
            color: var(--white);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .diners-table tbody tr {
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .diners-table tbody tr:hover {
            background-color: var(--light-gray);
        }

        .diners-table td {
            font-size: 0.9rem;
        }

        .table-totals {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 2px solid var(--gold);
        }

        .table-totals h3 {
            color: var(--navy);
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
        }

        .totals-list {
            list-style: none;
        }

        .totals-list li {
            padding: 0.5rem;
            background: var(--light-gray);
            margin-bottom: 0.5rem;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .edit-note {
            font-size: 0.875rem;
            color: var(--text-light);
            font-style: italic;
            margin-top: 0.5rem;
        }

        @media (max-width: 768px) {
            .diners-table {
                font-size: 0.85rem;
            }

            .diners-table th,
            .diners-table td {
                padding: 0.5rem 0.25rem;
            }

            /* Stack table on very small screens */
            @media (max-width: 600px) {
                .diners-table thead {
                    display: none;
                }

                .diners-table, 
                .diners-table tbody, 
                .diners-table tr, 
                .diners-table td {
                    display: block;
                    width: 100%;
                }

                .diners-table tr {
                    margin-bottom: 1rem;
                    border: 1px solid var(--medium-gray);
                    border-radius: 4px;
                    padding: 0.5rem;
                }

                .diners-table td {
                    text-align: right;
                    padding-left: 50%;
                    position: relative;
                    border-bottom: 1px solid var(--light-gray);
                }

                .diners-table td:last-child {
                    border-bottom: none;
                }

                .diners-table td::before {
                    content: attr(data-label);
                    position: absolute;
                    left: 0.5rem;
                    font-weight: 600;
                    color: var(--navy);
                }
            }
        }

        .diner-item {
            background: var(--light-gray);
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 4px;
            border-left: 3px solid var(--gold);
        }

        .diner-name {
            font-weight: 600;
            color: var(--navy);
            margin-bottom: 0.5rem;
        }

        .diner-details {
            font-size: 0.875rem;
            color: var(--text-light);
        }

        .form-card {
            background: var(--white);
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .form-card h2 {
            color: var(--navy);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
            font-weight: 400;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--navy);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .required {
            color: var(--error);
        }

        input[type="text"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        input[type="text"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--gold);
            box-shadow: 0 0 0 3px rgba(184, 134, 11, 0.1);
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 0.75rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--gold);
        }

        .checkbox-item label {
            margin-bottom: 0;
            font-weight: 400;
            cursor: pointer;
        }

        .dietary-section {
            background: var(--light-gray);
            padding: 1.25rem;
            border-radius: 4px;
            border: 1px solid var(--medium-gray);
        }

        .dietary-section h3 {
            color: var(--navy);
            font-size: 1.1rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--navy) 0%, #003d7a 100%);
            color: var(--white);
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #003d7a 0%, var(--navy) 100%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--white);
            color: var(--navy);
            border: 2px solid var(--navy);
        }

        .btn-secondary:hover {
            background: var(--navy);
            color: var(--white);
        }

        .button-group {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            border-radius: 8px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        .modal-header {
            border-bottom: 2px solid var(--gold);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .modal-header h3 {
            color: var(--navy);
            font-size: 1.5rem;
            font-weight: 400;
        }

        .confirmation-detail {
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: var(--light-gray);
            border-radius: 4px;
        }

        .confirmation-detail strong {
            color: var(--navy);
            display: block;
            margin-bottom: 0.25rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--white);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-left: 0.5rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error-message {
            background: #ffebee;
            color: var(--error);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--error);
        }

        .success-message {
            background: #e8f5e9;
            color: var(--success);
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--success);
        }

        .empty-state {
            text-align: center;
            color: var(--text-light);
            padding: 2rem;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .container {
                margin: 1rem auto;
            }

            .form-card,
            .event-info,
            .submitted-diners {
                padding: 1.5rem;
            }

            .checkbox-group {
                grid-template-columns: 1fr;
            }

            .button-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        #otherDescription {
            margin-top: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-placeholder">
            Logo Placeholder
        </div>
        <h1>Dining Registration</h1>
    </div>

    <div class="container">
        <div id="errorContainer"></div>
        
        <div id="deadlineNotice" class="event-info" style="display: none;">
            <p id="deadlineText" style="margin: 0;"></p>
        </div>

        <div id="bookingClosedMessage" class="error-message" style="display: none;">
            <strong>Booking Closed</strong><br>
            Booking for this event is now closed. If you need to discuss the event, please contact the Treasurer, Kev Couling at <a href="mailto:info@kevincouling.co.uk">info@kevincouling.co.uk</a>
        </div>

        <div id="bookingModeButtons" class="form-card" style="display: none; text-align: center;">
            <h2 style="margin-bottom: 2rem;">How would you like to proceed?</h2>
            <div class="button-group" style="justify-content: center;">
                <button type="button" class="btn btn-primary" id="startNewBookingBtn" style="min-width: 200px;">Start a New Booking</button>
                <button type="button" class="btn btn-secondary" id="amendBookingBtn" style="min-width: 200px;">Amend an Existing Booking</button>
            </div>
        </div>

        <div id="amendBookingRefInput" class="form-card" style="display: none;">
            <h2>Enter Your Booking Reference</h2>
            <form id="bookingRefForm">
                <div class="form-group">
                    <label for="bookingRefInput">Booking Reference <span class="required">*</span></label>
                    <input type="text" id="bookingRefInput" name="bookingRef" placeholder="e.g. 251212-001" required>
                </div>
                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Retrieve Booking</button>
                    <button type="button" class="btn btn-secondary" id="cancelAmendBtn">Cancel</button>
                </div>
            </form>
        </div>

        <div class="event-info" id="eventInfoSection" style="display: none;">
            <h2 id="eventName">Loading event information...</h2>
            <div class="event-detail">
                <strong>Date:</strong> <span id="eventDate">-</span>
            </div>
            <div class="menu-section">
                <h3>Menu</h3>
                <p id="eventMenu">Loading menu...</p>
            </div>
            <div class="cost-notice" id="costNotice">
                <strong>Cost:</strong> <span id="eventCost">-</span>
            </div>
        </div>

        <div class="submitted-diners" id="submittedDinersSection" style="display: none;">
            <h2>Registered Diners</h2>
            <div id="dinersTableContainer"></div>
            <p class="edit-note">Click a name to edit</p>
        </div>

        <div class="form-card" id="dinerFormCard" style="display: none;">
            <h2>Register a Diner</h2>
            <form id="dinerForm">
                <div class="form-group">
                    <label for="name">Name <span class="required">*</span></label>
                    <input type="text" id="name" name="name" required>
                </div>

                <div class="form-group">
                    <label for="dinerType">Diner Type <span class="required">*</span></label>
                    <select id="dinerType" name="dinerType" required>
                        <option value="">Please select...</option>
                        <option value="Member">Member</option>
                        <option value="Hicks Beach WM">Hicks Beach WM</option>
                        <option value="Guest">Guest</option>
                        <option value="Master's Guest">Master's Guest</option>
                        <option value="Lodge Guest">Lodge Guest</option>
                        <option value="Self-funded">Self-funded</option>
                    </select>
                </div>

                <div class="form-group" id="guestOfGroup" style="display: none;">
                    <label for="guestOf">Guest Of <span class="required">*</span></label>
                    <select id="guestOf" name="guestOf">
                        <option value="">Please select...</option>
                    </select>
                    <p style="font-size: 0.875rem; color: var(--text-light); margin-top: 0.5rem;">
                        Please ensure you have the permission of the member selected before registering a guest to their name.
                    </p>
                </div>

                <div class="form-group">
                    <label for="rank">Grand or Provincial Rank</label>
                    <input type="text" id="rank" name="rank">
                </div>

                <div class="dietary-section">
                    <h3>Dietary Requirements</h3>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="vegetarian" name="vegetarian">
                            <label for="vegetarian">Vegetarian</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="vegan" name="vegan">
                            <label for="vegan">Vegan</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="pescatarian" name="pescatarian">
                            <label for="pescatarian">Pescatarian</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="gluten" name="gluten">
                            <label for="gluten">Gluten Free</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="lactose" name="lactose">
                            <label for="lactose">Lactose Free</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="shellfish" name="shellfish">
                            <label for="shellfish">No Shellfish</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="fish" name="fish">
                            <label for="fish">No Fish</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="nuts" name="nuts">
                            <label for="nuts">No Nuts</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="other" name="other">
                            <label for="other">Other</label>
                        </div>
                    </div>
                    <div class="form-group" id="otherDescriptionGroup" style="display: none;">
                        <label for="otherDescription">Please specify other dietary requirements</label>
                        <input type="text" id="otherDescription" name="otherDescription">
                    </div>
                </div>

                <div class="form-group">
                    <label for="specialRequests">Special Requests</label>
                    <textarea id="specialRequests" name="specialRequests" rows="3"></textarea>
                </div>

                <div class="button-group">
                    <button type="submit" class="btn btn-primary">Submit Registration</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="confirmationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Confirm Diner Details</h3>
            </div>
            <div id="confirmationDetails"></div>
            <div class="button-group">
                <button type="button" class="btn btn-primary" id="confirmSubmit">Confirm & Submit</button>
                <button type="button" class="btn btn-secondary" id="cancelSubmit">Edit Details</button>
            </div>
        </div>
    </div>

    <script>
        // Configuration
        const AIRTABLE_CONFIG = {
            apiKey: 'patlpSPboR2VXuX4s.2356c73072130e640a12b23cf4ba27ef000afd84f615c6ec5d8d012c82d2bd27',
            baseId: 'appt2FP55Rbj2wCux',
            dinersTable: 'Diners',
            eventsTable: 'Events'
        };

        // State
        let currentEventData = null;
        let pendingDiner = null;
        let submittedDiners = [];
        let isLoading = false;
        let bookingMode = null; // 'new' or 'amend'
        let currentBookingRef = null;
        let registeredMembersFromAirtable = []; // Members already in Airtable for this event
        let editingDinerIndex = null; // Index of diner being edited, null if adding new

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadEventData();
            setupEventListeners();
        });

        function setupEventListeners() {
            const form = document.getElementById('dinerForm');
            form.addEventListener('submit', handleFormSubmit);

            document.getElementById('confirmSubmit').addEventListener('click', confirmAndSubmit);
            document.getElementById('cancelSubmit').addEventListener('click', closeModal);

            const otherCheckbox = document.getElementById('other');
            otherCheckbox.addEventListener('change', function() {
                const otherGroup = document.getElementById('otherDescriptionGroup');
                otherGroup.style.display = this.checked ? 'block' : 'none';
            });

            // Diner type change to show Guest Of field
            const dinerTypeSelect = document.getElementById('dinerType');
            dinerTypeSelect.addEventListener('change', handleDinerTypeChange);

            // Booking mode buttons
            document.getElementById('startNewBookingBtn').addEventListener('click', startNewBooking);
            document.getElementById('amendBookingBtn').addEventListener('click', showAmendBookingInput);
            document.getElementById('cancelAmendBtn').addEventListener('click', cancelAmendBooking);
            
            // Booking ref form
            document.getElementById('bookingRefForm').addEventListener('submit', handleBookingRefSubmit);
        }

        async function loadEventData() {
            if (isLoading) return;
            isLoading = true;
            
            try {
                console.log('=== Loading Event Data ===');
                console.log('URL:', `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.eventsTable}`);
                console.log('API Key (first 20 chars):', AIRTABLE_CONFIG.apiKey.substring(0, 20) + '...');
                
                const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.eventsTable}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });

                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('=== ERROR RESPONSE ===');
                    console.error('Status:', response.status);
                    console.error('Response text:', errorText);
                    
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                        console.error('Parsed error:', errorData);
                    } catch (e) {
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    throw new Error(`${errorData.error?.type || 'API_ERROR'}: ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();
                console.log('=== SUCCESS ===');
                console.log('Records received:', data.records.length);
                console.log('Full data:', data);
                
                if (data.records.length === 0) {
                    showError('No events found in the Events table. Please add at least one event in Airtable.');
                    return;
                }
                
                // Find active event
                const activeEvent = data.records.find(record => record.fields['Active Event']);
                console.log('Active event search result:', activeEvent);
                
                if (activeEvent) {
                    currentEventData = activeEvent.fields;
                    displayEventData(currentEventData);
                    console.log('✓ Active event loaded successfully:', currentEventData);
                } else {
                    console.warn('No active event found. Available events:', data.records.map(r => r.fields));
                    showError('No active event found. Please check the "Active Event" checkbox for one event in your Airtable Events table.');
                }
            } catch (error) {
                console.error('=== FATAL ERROR ===');
                console.error('Error type:', error.name);
                console.error('Error message:', error.message);
                console.error('Full error:', error);
                showError(`Unable to load event: ${error.message}`);
            } finally {
                isLoading = false;
            }
        }

        function displayEventData(eventData) {
            console.log('=== DISPLAYING EVENT DATA ===');
            console.log('Event data received:', eventData);
            
            document.getElementById('eventName').textContent = eventData['Event Name'] || 'Event';
            document.getElementById('eventDate').textContent = formatDate(eventData['Event Date']) || '-';
            document.getElementById('eventMenu').textContent = eventData['Menu Text'] || 'Menu information not available';
            
            const cost = eventData['Cost Per Meal'];
            if (cost) {
                document.getElementById('eventCost').textContent = `£${cost.toFixed(2)} per meal (payable by Members and Guests)`;
            } else {
                document.getElementById('costNotice').style.display = 'none';
            }

            // Show deadline notice
            const lastDayToBook = eventData['Last Day To Book'];
            console.log('Last Day To Book:', lastDayToBook);
            
            if (lastDayToBook) {
                const deadlineNotice = document.getElementById('deadlineNotice');
                const deadlineText = document.getElementById('deadlineText');
                deadlineText.innerHTML = `<strong>The last day for booking or amendments is ${formatDate(lastDayToBook)}.</strong>`;
                deadlineNotice.style.display = 'block';

                // Check if booking is closed
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const deadline = new Date(lastDayToBook);
                deadline.setHours(0, 0, 0, 0);

                console.log('Today:', today);
                console.log('Deadline:', deadline);
                console.log('Is booking closed?', today > deadline);

                if (today > deadline) {
                    // Booking is closed
                    console.log('Booking is closed - showing message');
                    document.getElementById('bookingClosedMessage').style.display = 'block';
                    return; // Don't show booking options
                }
            }

            // Show booking mode buttons
            console.log('Showing booking mode buttons');
            document.getElementById('bookingModeButtons').style.display = 'block';
        }

        function handleDinerTypeChange() {
            const dinerType = document.getElementById('dinerType').value;
            const guestOfGroup = document.getElementById('guestOfGroup');
            const guestOfSelect = document.getElementById('guestOf');

            if (dinerType === 'Guest') {
                // Get all members (from submitted diners in current session + Airtable)
                const membersInSession = submittedDiners.filter(d => 
                    d.dinerType === 'Member' || d.dinerType === 'Hicks Beach WM'
                );
                
                if (membersInSession.length === 0 && registeredMembersFromAirtable.length === 0) {
                    showError('Please register at least one member before registering guests');
                    document.getElementById('dinerType').value = '';
                    return;
                }

                // Populate the dropdown
                guestOfSelect.innerHTML = '<option value="">Please select...</option>';
                
                // Add members from current session
                if (membersInSession.length > 0) {
                    const sessionGroup = document.createElement('optgroup');
                    sessionGroup.label = 'In this booking';
                    membersInSession.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.name;
                        option.textContent = member.name;
                        sessionGroup.appendChild(option);
                    });
                    guestOfSelect.appendChild(sessionGroup);
                }

                // Add members from Airtable
                if (registeredMembersFromAirtable.length > 0) {
                    const airtableGroup = document.createElement('optgroup');
                    airtableGroup.label = 'Already registered';
                    registeredMembersFromAirtable.forEach(member => {
                        const option = document.createElement('option');
                        option.value = member.name;
                        option.textContent = member.name;
                        airtableGroup.appendChild(option);
                    });
                    guestOfSelect.appendChild(airtableGroup);
                }

                guestOfGroup.style.display = 'block';
                guestOfSelect.required = true;
            } else {
                guestOfGroup.style.display = 'none';
                guestOfSelect.required = false;
                guestOfSelect.value = '';
            }
        }

        async function startNewBooking() {
            bookingMode = 'new';
            currentBookingRef = generateBookingRef();
            
            // Load registered members from Airtable for this event
            await loadRegisteredMembers();
            
            // Hide mode selection, show event info and form
            document.getElementById('bookingModeButtons').style.display = 'none';
            document.getElementById('eventInfoSection').style.display = 'block';
            document.getElementById('dinerFormCard').style.display = 'block';
            
            console.log('Starting new booking with ref:', currentBookingRef);
        }

        async function loadRegisteredMembers() {
            if (!currentEventData || !currentEventData['Event Date']) {
                return;
            }

            try {
                // Get all diners for this event date who are Members or Hicks Beach WM
                const eventDate = currentEventData['Event Date'];
                const formula = encodeURIComponent(
                    `AND({Event Date} = '${eventDate}', OR({Diner Type} = 'Member', {Diner Type} = 'Hicks Beach WM'))`
                );
                
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.dinersTable}?filterByFormula=${formula}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`
                        }
                    }
                );

                if (!response.ok) {
                    console.error('Failed to load registered members');
                    return;
                }

                const data = await response.json();
                registeredMembersFromAirtable = data.records.map(record => ({
                    name: record.fields['Name'],
                    dinerType: record.fields['Diner Type']
                }));

                console.log('Loaded registered members from Airtable:', registeredMembersFromAirtable);

            } catch (error) {
                console.error('Error loading registered members:', error);
            }
        }

        function showAmendBookingInput() {
            bookingMode = 'amend';
            
            // Hide mode selection, show booking ref input
            document.getElementById('bookingModeButtons').style.display = 'none';
            document.getElementById('amendBookingRefInput').style.display = 'block';
        }

        function cancelAmendBooking() {
            bookingMode = null;
            currentBookingRef = null;
            
            // Show mode selection, hide booking ref input
            document.getElementById('amendBookingRefInput').style.display = 'none';
            document.getElementById('bookingModeButtons').style.display = 'block';
            
            // Clear the input
            document.getElementById('bookingRefInput').value = '';
        }

        async function handleBookingRefSubmit(e) {
            e.preventDefault();
            
            const bookingRef = document.getElementById('bookingRefInput').value.trim();
            console.log('Retrieving booking:', bookingRef);
            
            try {
                // Search for booking in Airtable
                const formula = encodeURIComponent(`{Booking Ref} = '${bookingRef}'`);
                const response = await fetch(
                    `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.dinersTable}?filterByFormula=${formula}`,
                    {
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`
                        }
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to retrieve booking');
                }

                const data = await response.json();
                
                if (data.records.length === 0) {
                    showError('Booking reference not found. Please check and try again.');
                    return;
                }

                // Load the booking
                currentBookingRef = bookingRef;
                submittedDiners = data.records.map(record => ({
                    id: record.id,
                    name: record.fields['Name'],
                    dinerType: record.fields['Diner Type'],
                    rank: record.fields['Grand or Provincial Rank'],
                    vegetarian: record.fields['Vegetarian'] || false,
                    vegan: record.fields['Vegan'] || false,
                    pescatarian: record.fields['Pescatarian'] || false,
                    gluten: record.fields['Gluten'] || false,
                    lactose: record.fields['Lactose'] || false,
                    shellfish: record.fields['Shellfish'] || false,
                    fish: record.fields['Fish'] || false,
                    nuts: record.fields['Nuts'] || false,
                    other: record.fields['Other'] || false,
                    otherDescription: record.fields['Other Description'] || '',
                    specialRequests: record.fields['Special Requests'] || '',
                    guestOf: record.fields['Guest Of'] || '',
                    recordId: record.id
                }));

                // Show event info, diners, and form
                document.getElementById('amendBookingRefInput').style.display = 'none';
                document.getElementById('eventInfoSection').style.display = 'block';
                document.getElementById('dinerFormCard').style.display = 'block';
                updateSubmittedDinersList();
                
                showSuccess(`Booking ${bookingRef} retrieved successfully!`);
                
            } catch (error) {
                console.error('Error retrieving booking:', error);
                showError(`Failed to retrieve booking: ${error.message}`);
            }
        }

        function generateBookingRef() {
            const now = new Date();
            const year = now.getFullYear().toString().slice(-2);
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            
            // For now, use a random 3-digit number
            // In Phase 2, we'll make this sequential based on existing bookings
            const sequence = Math.floor(Math.random() * 900) + 100;
            
            return `${year}${month}${day}-${sequence}`;
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-GB', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        }

        function handleFormSubmit(e) {
            e.preventDefault();
            
            const formData = new FormData(e.target);
            pendingDiner = {
                name: formData.get('name'),
                dinerType: formData.get('dinerType'),
                rank: formData.get('rank'),
                guestOf: formData.get('guestOf') || '',
                vegetarian: document.getElementById('vegetarian').checked,
                vegan: document.getElementById('vegan').checked,
                pescatarian: document.getElementById('pescatarian').checked,
                gluten: document.getElementById('gluten').checked,
                lactose: document.getElementById('lactose').checked,
                shellfish: document.getElementById('shellfish').checked,
                fish: document.getElementById('fish').checked,
                nuts: document.getElementById('nuts').checked,
                other: document.getElementById('other').checked,
                otherDescription: formData.get('otherDescription'),
                specialRequests: formData.get('specialRequests')
            };

            showConfirmationModal(pendingDiner);
        }

        function showConfirmationModal(diner) {
            const modal = document.getElementById('confirmationModal');
            const detailsContainer = document.getElementById('confirmationDetails');
            
            // Build dietary requirements string
            const dietary = [];
            if (diner.vegetarian) dietary.push('Vegetarian');
            if (diner.vegan) dietary.push('Vegan');
            if (diner.pescatarian) dietary.push('Pescatarian');
            if (diner.gluten) dietary.push('Gluten Free');
            if (diner.lactose) dietary.push('Lactose Free');
            if (diner.shellfish) dietary.push('No Shellfish');
            if (diner.fish) dietary.push('No Fish');
            if (diner.nuts) dietary.push('No Nuts');
            if (diner.other && diner.otherDescription) dietary.push(`Other: ${diner.otherDescription}`);
            
            const dietaryString = dietary.length > 0 ? dietary.join(', ') : 'None specified';

            // Calculate cost
            const costPerMeal = currentEventData['Cost Per Meal'] || 0;
            const cost = (diner.dinerType === 'Master\'s Guest' || diner.dinerType === 'Lodge Guest') ? 0 : costPerMeal;

            detailsContainer.innerHTML = `
                <div class="confirmation-detail">
                    <strong>Name</strong>
                    ${diner.name}
                </div>
                <div class="confirmation-detail">
                    <strong>Diner Type</strong>
                    ${diner.dinerType}
                </div>
                ${diner.guestOf ? `
                <div class="confirmation-detail">
                    <strong>Guest Of</strong>
                    ${diner.guestOf}
                </div>
                ` : ''}
                ${diner.rank ? `
                <div class="confirmation-detail">
                    <strong>Grand or Provincial Rank</strong>
                    ${diner.rank}
                </div>
                ` : ''}
                <div class="confirmation-detail">
                    <strong>Cost</strong>
                    £${cost.toFixed(2)}
                </div>
                <div class="confirmation-detail">
                    <strong>Dietary Requirements</strong>
                    ${dietaryString}
                </div>
                ${diner.specialRequests ? `
                <div class="confirmation-detail">
                    <strong>Special Requests</strong>
                    ${diner.specialRequests}
                </div>
                ` : ''}
            `;

            modal.classList.add('active');
        }

        function closeModal() {
            const modal = document.getElementById('confirmationModal');
            modal.classList.remove('active');
        }

        async function confirmAndSubmit() {
            const confirmBtn = document.getElementById('confirmSubmit');
            const cancelBtn = document.getElementById('cancelSubmit');
            const originalText = confirmBtn.innerHTML;
            
            console.log('=== SUBMIT BUTTON CLICKED ===');
            console.log('Pending diner:', pendingDiner);
            
            confirmBtn.innerHTML = 'Submitting<span class="loading"></span>';
            confirmBtn.disabled = true;
            cancelBtn.disabled = true;

            try {
                // Determine Guest Of value
                let guestOfValue = pendingDiner.guestOf || '';
                
                // For Members and Self-funded, they are their own "Guest Of"
                if (pendingDiner.dinerType === 'Member' || 
                    pendingDiner.dinerType === 'Hicks Beach WM' || 
                    pendingDiner.dinerType === 'Self-funded') {
                    guestOfValue = pendingDiner.name;
                }

                // Calculate cost
                const costPerMeal = currentEventData['Cost Per Meal'] || 0;
                const individualCost = (pendingDiner.dinerType === 'Master\'s Guest' || pendingDiner.dinerType === 'Lodge Guest') ? 0 : costPerMeal;

                const airtableData = {
                    fields: {
                        'Name': pendingDiner.name,
                        'Booking Ref': currentBookingRef,
                        'Event Date': currentEventData['Event Date'],
                        'Diner Type': pendingDiner.dinerType,
                        'Grand or Provincial Rank': pendingDiner.rank || '',
                        'Guest Of': guestOfValue,
                        'Total To Pay': 0, // Will be updated after all diners submitted
                        'Vegetarian': pendingDiner.vegetarian,
                        'Vegan': pendingDiner.vegan,
                        'Pescatarian': pendingDiner.pescatarian,
                        'Gluten': pendingDiner.gluten,
                        'Lactose': pendingDiner.lactose,
                        'Shellfish': pendingDiner.shellfish,
                        'Fish': pendingDiner.fish,
                        'Nuts': pendingDiner.nuts,
                        'Other': pendingDiner.other,
                        'Other Description': pendingDiner.otherDescription || '',
                        'Special Requests': pendingDiner.specialRequests || ''
                    }
                };

                console.log('Submitting to Airtable:', airtableData);
                console.log('Editing mode:', editingDinerIndex !== null);
                
                let response;
                let result;

                if (editingDinerIndex !== null) {
                    // UPDATE existing diner
                    const recordId = submittedDiners[editingDinerIndex].recordId || submittedDiners[editingDinerIndex].id;
                    console.log('Updating record ID:', recordId);
                    console.log('URL:', `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.dinersTable}/${recordId}`);
                    
                    response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.dinersTable}/${recordId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(airtableData)
                    });
                } else {
                    // CREATE new diner
                    console.log('URL:', `https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.dinersTable}`);
                    
                    response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.dinersTable}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(airtableData)
                    });
                }

                console.log('Submit response status:', response.status);
                console.log('Submit response ok:', response.ok);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Submit error response:', errorText);
                    
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        throw new Error(`HTTP ${response.status}: ${errorText}`);
                    }
                    throw new Error(errorData.error?.message || 'Failed to submit registration');
                }

                result = await response.json();
                console.log('✓ Successfully submitted! Result:', result);
                
                // Update submitted diners list
                if (editingDinerIndex !== null) {
                    // Update existing diner
                    submittedDiners[editingDinerIndex] = {
                        ...pendingDiner,
                        id: result.id,
                        recordId: result.id,
                        guestOf: guestOfValue,
                        cost: individualCost
                    };
                    showSuccess(`Successfully updated ${pendingDiner.name}!`);
                } else {
                    // Add new diner
                    submittedDiners.push({
                        ...pendingDiner,
                        id: result.id,
                        recordId: result.id,
                        guestOf: guestOfValue,
                        cost: individualCost
                    });
                    showSuccess(`Successfully registered ${pendingDiner.name}!`);
                }
                
                console.log('Updated submitted diners list:', submittedDiners);
                
                // Reset editing mode
                editingDinerIndex = null;
                
                // Close modal first
                closeModal();
                
                // Then update the display
                updateSubmittedDinersList();
                
                // Update totals in Airtable
                await updateTotalsToPay();
                
                // Reset form for next entry
                resetForm();
                
            } catch (error) {
                console.error('=== SUBMIT ERROR ===');
                console.error('Error:', error);
                showError(`Failed to submit registration: ${error.message}`);
            } finally {
                // Always re-enable buttons
                confirmBtn.innerHTML = originalText;
                confirmBtn.disabled = false;
                cancelBtn.disabled = false;
            }
        }

        function updateSubmittedDinersList() {
            const section = document.getElementById('submittedDinersSection');
            const container = document.getElementById('dinersTableContainer');
            
            if (submittedDiners.length === 0) {
                section.style.display = 'none';
                return;
            }

            section.style.display = 'block';
            
            // Build table
            let tableHtml = `
                <table class="diners-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Diner Type</th>
                            <th>Guest Of</th>
                            <th>Cost</th>
                            <th>Dietary Requirements</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            submittedDiners.forEach((diner, index) => {
                const dietary = [];
                if (diner.vegetarian) dietary.push('Vegetarian');
                if (diner.vegan) dietary.push('Vegan');
                if (diner.pescatarian) dietary.push('Pescatarian');
                if (diner.gluten) dietary.push('Gluten Free');
                if (diner.lactose) dietary.push('Lactose Free');
                if (diner.shellfish) dietary.push('No Shellfish');
                if (diner.fish) dietary.push('No Fish');
                if (diner.nuts) dietary.push('No Nuts');
                if (diner.other && diner.otherDescription) dietary.push(`Other: ${diner.otherDescription}`);
                
                const dietaryString = dietary.length > 0 ? dietary.join(', ') : 'None';
                const cost = diner.cost !== undefined ? diner.cost : 0;
                const guestOf = diner.guestOf || '-';

                tableHtml += `
                    <tr onclick="editDiner(${index})" data-index="${index}">
                        <td data-label="Name">${diner.name}</td>
                        <td data-label="Diner Type">${diner.dinerType}</td>
                        <td data-label="Guest Of">${guestOf}</td>
                        <td data-label="Cost">£${cost.toFixed(2)}</td>
                        <td data-label="Dietary">${dietaryString}</td>
                    </tr>
                `;
            });

            tableHtml += `
                    </tbody>
                </table>
            `;

            // Calculate and display totals per paying member
            const totals = calculateTotalsPerMember();
            
            // Filter out members with £0 total
            const payingTotals = Object.entries(totals).filter(([member, total]) => total > 0);
            
            if (payingTotals.length > 0) {
                tableHtml += '<div class="table-totals"><h3>Totals to Pay:</h3><ul class="totals-list">';
                for (const [member, total] of payingTotals) {
                    tableHtml += `<li><strong>${member}</strong><span>£${total.toFixed(2)}</span></li>`;
                }
                tableHtml += '</ul></div>';
            }

            container.innerHTML = tableHtml;

            // Scroll to the submitted diners section
            section.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function editDiner(index) {
            console.log('Editing diner at index:', index);
            const diner = submittedDiners[index];
            
            // Set editing mode
            editingDinerIndex = index;
            
            // Populate form with existing data
            document.getElementById('name').value = diner.name || '';
            document.getElementById('dinerType').value = diner.dinerType || '';
            document.getElementById('rank').value = diner.rank || '';
            document.getElementById('vegetarian').checked = diner.vegetarian || false;
            document.getElementById('vegan').checked = diner.vegan || false;
            document.getElementById('pescatarian').checked = diner.pescatarian || false;
            document.getElementById('gluten').checked = diner.gluten || false;
            document.getElementById('lactose').checked = diner.lactose || false;
            document.getElementById('shellfish').checked = diner.shellfish || false;
            document.getElementById('fish').checked = diner.fish || false;
            document.getElementById('nuts').checked = diner.nuts || false;
            document.getElementById('other').checked = diner.other || false;
            document.getElementById('otherDescription').value = diner.otherDescription || '';
            document.getElementById('specialRequests').value = diner.specialRequests || '';
            
            // Handle Guest Of field
            if (diner.dinerType === 'Guest') {
                handleDinerTypeChange();
                setTimeout(() => {
                    document.getElementById('guestOf').value = diner.guestOf || '';
                }, 100);
            }
            
            // Show other description if needed
            if (diner.other) {
                document.getElementById('otherDescriptionGroup').style.display = 'block';
            }
            
            // Scroll to form
            document.getElementById('dinerFormCard').scrollIntoView({ behavior: 'smooth', block: 'start' });
            
            showSuccess('Editing diner - update the form and click Submit to save changes');
        }

        async function updateTotalsToPay() {
            console.log('=== UPDATING TOTALS TO PAY ===');
            
            // Calculate totals per paying member
            const totals = calculateTotalsPerMember();
            console.log('Calculated totals:', totals);
            
            // Update each member's Total To Pay in Airtable
            const updatePromises = [];
            
            for (const diner of submittedDiners) {
                const guestOf = diner.guestOf || diner.name;
                const totalToPay = totals[guestOf] || 0;
                
                // Only update if this person is the one paying (their name matches guestOf)
                if (diner.name === guestOf) {
                    const recordId = diner.recordId || diner.id;
                    
                    console.log(`Updating ${diner.name} with total: £${totalToPay}`);
                    
                    const updateData = {
                        fields: {
                            'Total To Pay': totalToPay
                        }
                    };
                    
                    const promise = fetch(`https://api.airtable.com/v0/${AIRTABLE_CONFIG.baseId}/${AIRTABLE_CONFIG.dinersTable}/${recordId}`, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${AIRTABLE_CONFIG.apiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    });
                    
                    updatePromises.push(promise);
                }
            }
            
            // Wait for all updates to complete
            try {
                await Promise.all(updatePromises);
                console.log('✓ All totals updated successfully');
            } catch (error) {
                console.error('Error updating totals:', error);
            }
        }

        function calculateTotalsPerMember() {
            const totals = {};
            
            submittedDiners.forEach(diner => {
                const guestOf = diner.guestOf || diner.name;
                const cost = diner.cost || 0;
                
                if (!totals[guestOf]) {
                    totals[guestOf] = 0;
                }
                totals[guestOf] += cost;
            });

            return totals;
        }

        function resetForm() {
            document.getElementById('dinerForm').reset();
            document.getElementById('otherDescriptionGroup').style.display = 'none';
            document.getElementById('guestOfGroup').style.display = 'none';
            pendingDiner = null;
            editingDinerIndex = null;
        }

        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error-message">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }

        function showSuccess(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="success-message">${message}</div>`;
            setTimeout(() => {
                container.innerHTML = '';
            }, 3000);
        }
    </script>
</body>
</html>
